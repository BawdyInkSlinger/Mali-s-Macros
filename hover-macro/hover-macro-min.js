/* Mali's <<hover>> macro */

(()=>{let t=0,e=!1;const s=$("<div>").attr({id:"macro-hover-tip","aria-live":"polite"}),i=()=>{e=!1,s.attr({"aria-hidden":!0}).removeClass().empty()};$(document).on("scroll",(i=>{if(!e)return;const a=$(document).scrollTop(),n=a-t,c=Number(s.css("top").slice(0,-2));s.css({top:c-n}),t=a})).on(":passageinit",i),Macro.add("hover",{tags:["swap","tip"],handler(){const a=this.payload[0].contents;let n=!1,c=[];const o=$("<span>").attr(this.args.find((t=>"object"==typeof t))??{}).attr("tabindex","0").addClass(`macro-${this.name}`).wiki(a),r={};this.payload.slice(1).forEach((t=>{r[t.name]=t,o.addClass(t.name)})),r.tip&&(c=r.tip.args.map((t=>t.split(" "))).flat(),o.attr("role","tooltip"));const d=this.shadowHandler??this.createShadowWrapper;o.on("mouseenter focus",d.call(this,(()=>{n||(n=!0,r.swap&&o.empty().wiki(r.swap.contents),r.tip&&((i,a,n)=>{e=!0,t=$(document).scrollTop(),a.append(s),s.removeClass().wiki(i);const{height:c,width:o}=s[0].getBoundingClientRect(),r=a[0].getBoundingClientRect();r.center={y:r.top+r.height/2,x:r.left+r.width/2};const d={up:{at:[r.center.x,r.top],stickOut:{main:-(c+4),sec:o/2}},down:{at:[r.center.x,r.bottom],stickOut:{main:c+4,sec:o/2}},left:{at:[r.left,r.center.y],stickOut:{main:-(o+4),sec:c/2}},right:{at:[r.right,r.center.y],stickOut:{main:o+4,sec:c/2}},over:{at:[r.center.x,r.center.y],stickOut:{main:0,sec:0}}},p=t=>{const e=d[t],s=[];switch(t){case"up":case"down":const t=e.at[1]+e.stickOut.main;s.push(t>0&&t<window.innerHeight,e.at[0]-e.stickOut.sec>0,e.at[0]+e.stickOut.sec<window.innerWidth);break;case"left":case"right":const i=e.at[0]+e.stickOut.main;s.push(i>0&&i<window.innerWidth,e.at[1]-e.stickOut.sec>0,e.at[1]+e.stickOut.sec<window.innerHeight);break;default:s.push(!0)}return s.every((t=>t))};(n=n.find((t=>p(t))))||(n=["up","right","down","left","over"].find((t=>p(t))));let[l,h]=d[n].at,{main:u,sec:m}=d[n].stickOut;switch(n){case"up":h+=u,l-=m;break;case"down":h+=4,l-=m;break;case"left":h-=m,l+=u;break;case"right":h-=m,l+=4;break;default:l-=o/2,h-=c/2}s.attr({"aria-hidden":!1}).css({top:h,left:l}).addClass("visible "+n)})(r.tip.contents,o,c))}))).on("mouseleave focusout",d.call(this,(()=>{n=!1,r.swap&&o.empty().wiki(a),r.tip&&i()}))).appendTo($(this.output))}})})();