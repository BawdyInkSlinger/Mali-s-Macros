/* Mali's arrowbox macro */

Macro.add("arrowbox",{arrows:{up:{symbol:"🞁",key:"ArrowUp"},down:{symbol:"🞃",key:"ArrowDown"},left:{symbol:"🞀",key:"ArrowLeft"},right:{symbol:"🞂",key:"ArrowRight"}},arrowElementType:"button",wrapperDesc:"Arrow keys or scroll to cycle",cycleCooldown:400,tags:["option","optionsfrom"],skipArgs:["optionsfrom"],isAsync:!0,addOptions:function(e,t,a){a&&(this.selected=this.length);const s={label:e,value:t??e};this.push(s)},runAnimation:function(e,t,a){e.addClass(t).one("animationend",(()=>{e.removeClass(t),a&&a()}))},handler(){const e=this.args[0].trim(),t=[],a=this.self.addOptions.bind(t),s=this.self.runAnimation,i={direction:this.args.find((e=>"horizontal"===e||"vertical"===e))??"horizontal",cycleWrap:this.args.includes("wrap"),autofocus:this.args.includes("autofocus"),animations:!this.args.includes("no-animations")||!0,centerInput:this.args.includes("type-in")};switch(this.payload.filter((e=>"option"===e.name)).forEach((e=>a(e.args[0],e.args[1],e.args.includes("selected")))),this.payload.filter((e=>"optionsfrom"===e.name)).forEach((e=>{const t=e.arguments.trim(),s=Scripting.evalTwineScript("{"===t[0]?`(${t})`:t);if(Array.isArray(s)||s instanceof Set)s.forEach((e=>a(e)));else if(s instanceof Map)s.forEach(((e,t)=>a(t,e)));else{if("object"!=typeof s)return this.error("The contents of the 'optionsfrom' tag should evaluate to a valid collection.");$.each(s,((e,t)=>a(e,t)))}})),t.length){case 0:return this.error(`The ${this.name} macro cannot be called without any options.`);case 1:i.cycleWrap=!1}let r=0,n=!0;if(t.hasOwnProperty("selected"))i.startValue=t[t.selected],r=t.selected;else{const a=State.getVar(e);void 0!==a&&t.find((e=>e.value===a))?(i.startValue=t.find((e=>e.value===a)),r=t.indexOf(i.startValue)):i.startValue=t[0]}State.setVar(e,i.startValue.value);const o=[],l=$("<form>").attr({id:`${this.name}-${Util.slugify(e)}`,class:`macro-${this.name} ${i.direction}`,title:(i.centerInput?"Crtl + ":"")+this.self.wrapperDesc,role:"group",tabindex:i.centerInput?"-1":"0"}),c=$(`<${i.centerInput?"input type='text'":"div"}>`).attr({class:`${this.name}-value`}).appendTo(l),p=$("<div>").addClass("anim-wrapper").attr("aria-live","polite").appendTo(c);function u(){i.cycleWrap?(r%=t.length,r<0&&(r=t.length-1)):(r?o[0].is(":disabled")&&o[0].ariaDisabled(!1):o[0].ariaDisabled(!0),r===t.length-1?o[1].ariaDisabled(!0):o[1].is(":disabled")&&o[1].ariaDisabled(!1))}const d=(t,a,r)=>{if(n=!1,setTimeout((()=>{n=!0}),this.self.cycleCooldown),i.centerInput)c.val(t.label),c[0].style.width=.9*String(t.label).length+"ch",a&&c.focus();else if(i.animations&&r){s(p,`slide${r}`,(()=>{p.empty().wiki(t.label)}))}else p.empty().wiki(t.label);State.setVar(e,t.value)};({horizontal:["left","right"],vertical:["up","down"]})[i.direction].forEach(((e,a)=>{const s=this.self.arrows[e],p=$(`<${this.self.arrowElementType}>`).append(s.symbol).attr({class:`${this.name}-arrow-${e}`,"data-key":s.key}),h=i.centerInput?c:l;p.ariaClick({namespace:".macros",label:a?"Next":"Previous","aria-label":a?"Next":"Previous",role:"button"},(()=>{h.focus(),r+=a?1:-1,u(),d(t[r],!0,e)})).attr("tabindex",i.centerInput?"0":"-1"),h.on("keydown",(e=>{const t=!i.centerInput||e.ctrlKey;if(n&&t&&e.key===s.key)return p.click(),e.preventDefault(),!1})),o.push(p),l[a?"append":"prepend"](p)})),i.centerInput&&c.on("input",(e=>{t[r]={label:c.val(),value:c.val()},d(t[r])})),l.on("wheel",(e=>{n&&o[e.originalEvent.deltaY<0?1:0].click()})),d(i.startValue),u(),i.autofocus&&setTimeout((()=>l.focus()),200),$(this.output).append(l)}});