/* Maliface's <<on/once>> and <<trigger>> macros */

(()=>{const t=[];$(document).on(":passageend",(()=>{let e=t.length-1;for(;e>=0;){const{element:s,id:n,type:a}=t[e];s.isConnected||($(document).off(a+"."+n),t.splice(e,1)),e--}}));let e=0;Macro.add(["on","once"],{isAsync:!0,tags:null,handler(){if(!this.args[0])return this.error("Missing event type.");let s,n,a,i,o=this.args.shift();for("string"==typeof o&&(o=o.trim().split(/\s|,/g));this.args.length;){const t=this.args.pop();if("object"!=typeof t)switch(t){case"hidden":case"startsHidden":i=!0;continue;case"transition":case"t8n":s=!0;continue;default:a=t}else n=t}const r=$(`<${a||"span"}>`).attr({"aria-live":"polite"}).attr(n??{}).addClass("macro-"+this.name);i||r.wiki(this.payload[0].contents);const d=t=>{r[0].isConnected&&(State.temporary.event=t,this.addShadow("_event"),r.empty().wiki(this.payload[0].contents),s&&r.fadeOut(0).fadeIn(400))},c=this.shadowHandler??this.createShadowWrapper;for(const s of o){const n={element:r[0],type:s,id:"m-on-"+e++};$(document)["once"===this.name?"one":"on"](s+"."+n.id,c.call(this,d)),t.push(n)}r.appendTo(this.output)}}),Macro.add("trigger",{handler(){let t=this.args[0],e=this.args[1]??document;"string"==typeof t&&(t=t.trim().split(/\s|,/g)),Array.isArray(t)||(t=[t]);for(const s of t)$(e).trigger(s)}})})();