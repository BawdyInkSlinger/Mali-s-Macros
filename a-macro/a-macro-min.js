/* Mali's <<a>> macro for Sugarcube */

(()=>{const e=[];$(document).on("keyup.macro-a",(t=>{e.filter((e=>e.key===t.key||e.key===t.code)).forEach((e=>e.elem.trigger("click")))})).on(":passageinit",(t=>{e.forEach((t=>{$.contains(document.body,t.elem[0])||e.delete(t)}))}));const t={prep:"prepend",app:"append",rep:"replace",after:"append",before:"append"},a=e=>{const t=typeof e;return"string"===t?Scripting.evalTwineScript(e):"function"===t?e.call():e},r=e=>"string"==typeof e?e.split(",").map((e=>e.trim())):Array.isArray(e)?clone(e):[e];Macro.add(["a","adel","but","butdel"],{isAsync:!0,tags:["rep","prep","app","diag","after","before"],handler(){let o,n,[i,...s]=this.args,[c,...l]=this.payload,p=[e=>$.wiki(c.contents)],d=[],h=[],f=this.name.includes("del"),g=0;s=(e=>{let t={},a=0;for(;a<e.length;){const r=e[a];if("object"==typeof r)Array.isArray(r)?e.splice(a--,1,...r):Object.assign(t,r);else{const o=e[a+=1];if(void 0===o)throw new Error("Uneven number of arguments.");if("string"!=typeof r)throw new Error(`Attribute key must be a string, reading: '${r}'.`);t[r.toLowerCase()]=o}a++}return t})(s);const u="b"===this.name[0]?"button":"link",y=$(`<${"button"===u?u:"a"}>`);if("object"==typeof i&&({text:i,link:o,source:n}=i),s.hasOwnProperty("goto")&&(o="object"==typeof s.goto?s.goto.link:s.goto,delete s.goto),o&&(d.push((e=>Engine.play(o))),y.attr("data-passage",o),Config.addVisitedLinkClass&&State.hasPlayed(o)?y.addClass("link-visited"):Story.has(o)||y.addClass("link-broken")),s.hasOwnProperty("trigger")){const e=r(s.trigger);d.push((t=>e.forEach((e=>$(document).trigger(e))))),delete s.trigger}if(s.hasOwnProperty("count")){const e=s.count-1;d.push((t=>g===e?y.remove():y.attr("data-count",g))),y.attr("data-count",g),delete s.count}if(s.hasOwnProperty("choice")){const e=r(s.choice);d.push((t=>e.forEach((e=>$("[data-choice]").not(y).trigger(":choiceCheck",e))))),y.attr("data-choice",!0).on(":choiceCheck",((t,a)=>{e.includes(a)&&y.remove()})),delete s.choice}if(s.hasOwnProperty("key")){r(s.key).forEach((t=>e.push({key:t,elem:y}))),delete s.key}if(s.hasOwnProperty("condition")){const e=clone(s.condition);delete s.condition,h.push((t=>y[a(e)?"show":"hide"]()))}if(s.hasOwnProperty("disabled")){const e=clone(s.disabled);delete s.disabled,h.push((t=>y.ariaDisabled(a(e))))}if(s.hasOwnProperty("changer")){const e=clone(s.changer);delete s.changer,h.push((t=>y.empty().wiki("function"==typeof e?e():e)))}l.forEach((e=>{let a;if("diag"===e.name)return a=t=>{Dialog.setup(e.args[0]||"",e.args[1]||""),Dialog.wiki(e.contents).open()},p.push(a);const r=e.args.find((e=>"object"==typeof e&&!(e instanceof jQuery)))||{},o=e.args.includesAny("transition","t8n")||false;a=a=>{let n=e.args[0]?$(e.args[0]):["before","after"].includes(e.name)?y:y.parent(),i=t[e.name];const s=$("<span>").attr(r).addClass(`macro-${i}-insert`).wiki(e.contents);switch(e.name){case"prep":n.prepend(s);break;case"rep":n.empty();case"app":n.append(s);break;default:n[e.name](s)}o&&(s.addClass(`macro-${i}-in`),setTimeout((e=>s.removeClass(`macro-${i}-in`)),Engine.minDomActionDelay))},p.push(a)})),f&&d.push((e=>y.remove())),y.wikiWithOptions({profile:"core"},n?`<img src='${n}' class='link-image'>`:i).attr(s).addClass(`macro-${this.name} link-${s.href?"external":"internal"}`),h.length&&(h.forEach((e=>e.call())),y.attr("data-checkself",!0).on(":checkSelf",this.createShadowWrapper((()=>h.forEach((e=>e.call())))))),y.ariaClick({namespace:".macros",role:u,one:!!o||f},this.createShadowWrapper((e=>{const t=State.temporary.this;State.temporary.this={event:e,self:y,count:g};try{p.forEach((t=>t.call(null,e)))}finally{State.temporary.this=t}}),(e=>{g++,d.forEach((t=>t.call(null,e))),setTimeout((()=>$("[data-checkself]").trigger(":checkSelf",40)))}))),this.output.appendChild(y.get(0))}})})();

/* End of <<a>> macro */