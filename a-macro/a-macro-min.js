/* Mali's <<a>> macro for Sugarcube */

(()=>{const e=[];$(document).on("keyup.macro-a",(t=>{e.filter((e=>e.key===t.key||e.key===t.code)).forEach((e=>e.elem.trigger("click")))})).on(":passageinit",(()=>{e.forEach((t=>{$.contains(document.body,t.elem[0])||e.delete(t)}))}));const t=(e,t=typeof e)=>"string"===t?Scripting.evalTwineScript(e):"function"===t?e.call():e,a=e=>"string"==typeof e?e.split(",").map((e=>e.trim())):Array.isArray(e)?clone(e):[e],c=(e,t,a)=>{const c=e.find((e=>"object"==typeof e))??{},o=e.includesAny("t8n","transition"),n=$("<span>").attr(c).addClass(`a-${t}-insert`).wiki(a);return o&&n.addClass("a-insert-in"),n},o={to(e,t,a){a.output=$(e)},once(e,t,a){a.selfDelete=e},count(e,t,a){a.click.max=parseInt(e)},goto(e,t,a){"object"==typeof e&&(e=e.link),a.passage=e},key(t,c){a(t).forEach((t=>e.push({key:t,elem:c})))},trigger:{type:"post",getHandler:e=>(e=a(e),()=>e.forEach((e=>$(document).trigger(e))))},choice:{type:"post",getHandler:(e,t)=>(e=a(e),t.attr("data-choice",!0).on(":choiceCheck",((a,c)=>{e.includes(c)&&t.remove()})),()=>{e.forEach((e=>$("[data-choice]").not(t).trigger(":choiceCheck",e)))})},condition:{type:"check",getHandler:(e,a)=>("string"!=typeof e&&(e=clone(e)),()=>{a[t(e)?"show":"hide"]()})},disabled:{type:"check",getHandler:(e,a)=>("string"!=typeof e&&(e=clone(e)),()=>{a.ariaDisabled(t(e))})},changer:{type:"check",getHandler:(e,t)=>("string"!=typeof e&&(e=clone(e)),()=>{t.empty().wiki("function"==typeof e?e():e)})}},n={diag(e,t){Dialog.setup(e[0]||"",e[1]||""),Dialog.wiki(t).open()},rep(e,t,a){$(e[0]||a.parent()).empty().wiki(t)},prep(e,t,a){const[o,...n]=e;$(o||a.parent()).prepend(c(n,"prepend",t))},app(e,t,a){const[o,...n]=e;$(o||a.parent()).append(c(n,"append",t))},after(e,t,a){const[o,...n]=e;$(o||a).after(c(n,"after",t))},before(e,t,a){const[o,...n]=e;$(o||a).before(c(n,"before",t))}};Macro.add(["a","adel","but","butdel"],{isAsync:!0,tags:Object.keys(n),handler(){let[e,...t]=this.args,[a,...c]=this.payload;t=(e=>{let t={},a=0;for(;a<e.length;){const c=e[a];if("object"==typeof c)Array.isArray(c)?e.splice(a--,1,...c):Object.assign(t,c);else{const o=e[a+=1];if(void 0===o)throw new Error("Uneven number of arguments.");if("string"!=typeof c)throw new Error(`Attribute key must be a string, reading: '${c}'.`);t[c.toLowerCase()]=o}a++}return t})(t);const s={callbacks:{click:[()=>$.wiki(a.contents)],check:[],post:[]},click:{count:0,max:1/0},output:$(this.output),passage:null,type:"b"===this.name[0]?"button":"link",text:e,selfDelete:this.name.includes("del")},r=$(`<${"button"===s.type?s.type:"a"}>`);"object"==typeof e&&(s.text=e.text,s.passage=e.link,e.source&&(s.text=`<img src='${e.source}' class='link-image'>`));for(const e in o){if(!t.hasOwnProperty(e))continue;const a=o[e];if("function"==typeof a)a.call(this,t[e],r,s);else{const c=a.getHandler(t[e],r,s);s.callbacks[a.type].push(c)}delete t[e]}if(r.attr(t).addClass(`macro-${this.name} link-${t.href?"external":"internal"}`).wikiWithOptions({profile:"core"},s.text),s.passage){const e=s.passage;s.callbacks.post.push((()=>Engine.play(e))),r.attr("data-passage",e),Config.addVisitedLinkClass&&State.hasPlayed(e)?r.addClass("link-visited"):Story.has(e)||r.addClass("link-broken")}c.forEach((e=>{const t=n[e.name].bind(null,e.args,e.contents,r);s.callbacks.click.push(t)})),s.selfDelete&&postClick.push((()=>r.remove())),s.callbacks.check.length&&(s.callbacks.check.forEach((e=>e.call())),r.attr("data-checkself",!0).on(":checkSelf",this.createShadowWrapper((()=>s.callbacks.check.forEach((e=>e.call()))))));const i=this.createShadowWrapper((e=>{const t=State.temporary.this;State.temporary.this={event:e,self:r,count:s.click.count};try{s.callbacks.click.forEach((e=>e()))}finally{State.temporary.this=t}}),(()=>{s.click.count++,s.callbacks.post.forEach((e=>e())),s.click.count>s.click.max&&r.remove(),setTimeout((()=>$("[data-checkself]").trigger(":checkSelf")),40)}));r.ariaClick({namespace:".macros",role:s.type},i).appendTo(s.output)}})})();