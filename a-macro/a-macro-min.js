/* Mali's <<a>> macro for Sugarcube */

(()=>{const e=[];$(document).on("keyup.macro-a",(t=>{e.filter((e=>e.key===t.key||e.key===t.code)).forEach((e=>e.elem.trigger("click")))})).on(":passageinit",(t=>{e.forEach((t=>{$.contains(document.body,t.elem[0])||e.delete(t)}))}));const t={prep:"prepend",app:"append",rep:"replace"},a=e=>{const t=typeof e;return"string"===t?Scripting.evalTwineScript(e):"function"===t?e.call():e},o=e=>"string"==typeof e?e.split(",").map((e=>e.trim())):Array.isArray(e)?clone(e):[e];Macro.add(["a","adel","but","butdel"],{isAsync:!0,tags:["rep","prep","app","diag"],handler(){let r,n,[i,...s]=this.args,[c,...l]=this.payload,p=[e=>$.wiki(c.contents)],d=[],h=[],g=this.name.includes("del"),u=0;s=(e=>{let t={},a=0;for(;a<e.length;){const o=e[a];if("object"==typeof o)Array.isArray(o)?e.splice(a--,1,...o):Object.assign(t,o);else{const r=e[a+=1];if(void 0===r)throw new Error("Uneven number of arguments.");if("string"!=typeof o)throw new Error(`Attribute key must be a string, reading: '${o}'.`);t[o.toLowerCase()]=r}a++}return t})(s);const f="b"===this.name[0]?"button":"link",y=$(`<${"button"===f?f:"a"}>`);if("object"==typeof i&&({text:i,link:r,source:n}=i),s.hasOwnProperty("goto")&&(r="object"==typeof s.goto?s.goto.link:s.goto,delete s.goto),r&&(d.push((e=>Engine.play(r))),y.attr("data-passage",r),Config.addVisitedLinkClass&&State.hasPlayed(r)?y.addClass("link-visited"):Story.has(r)||y.addClass("link-broken")),s.hasOwnProperty("trigger")){const e=o(s.trigger);d.push((t=>e.forEach((e=>$(document).trigger(e))))),delete s.trigger}if(s.hasOwnProperty("count")){const e=s.count-1;d.push((t=>u===e?y.remove():y.attr("data-count",u+=1))),y.attr("data-count",u),delete s.count}if(s.hasOwnProperty("choice")){const e=o(s.choice);d.push((t=>e.forEach((e=>$("[data-choice]").not(y).trigger(":choiceCheck",e))))),y.attr("data-choice",!0).on(":choiceCheck",((t,a)=>{e.includes(a)&&y.remove()})),delete s.choice}if(s.hasOwnProperty("key")){o(s.key).forEach((t=>e.push({key:t,elem:y}))),delete s.key}if(s.hasOwnProperty("condition")){const e=clone(s.condition);delete s.condition,h.push((t=>y[a(e)?"show":"hide"]()))}if(s.hasOwnProperty("disabled")){const e=clone(s.disabled);delete s.disabled,h.push((t=>y.ariaDisabled(a(e))))}h.length&&(h.forEach((e=>e.call())),y.attr("data-checkself",!0).on(":checkSelf",(e=>h.forEach((e=>e.call()))))),l.forEach((e=>{let a;if("diag"===e.name)return a=t=>{Dialog.setup(e.args[0]||"",e.args[1]||""),Dialog.wiki(e.contents).open()},void p.push(a);const o=e.args.find((e=>"object"==typeof e&&!(e instanceof jQuery)))||{},r=e.args.includesAny("transition","t8n");a=a=>{const n=e.args[0]?$(e.args[0]):y.parent(),i=t[e.name];"rep"===e.name&&n.empty();const s=$("<span>").attr(o).addClass(`macro-${i}-insert`).wiki(e.contents);n["prep"===e.name?"prepend":"append"](s),r&&(s.addClass(`macro-${i}-in`),setTimeout((()=>s.removeClass(`macro-${i}-in`)),40))},p.push(a)})),g&&d.push((e=>y.remove())),y.wikiWithOptions({profile:"core"},n?`<img src='${n}' class='link-image'>`:i).attr(s).addClass(`macro-${this.name} link-${s.href?"external":"internal"}`),y.ariaClick({namespace:".macros",role:f,one:!!r||g},this.createShadowWrapper((e=>{const t=State.temporary.this;State.temporary.this={event:e,self:y,count:u};try{p.forEach((t=>t.call(null,e)))}finally{State.temporary.this=t}}),(e=>{d.forEach((t=>t.call(null,e))),setTimeout((()=>$("[data-checkself]").trigger(":checkSelf",40)))}))),this.output.appendChild(y.get(0))}})})();